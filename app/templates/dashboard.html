{% extends "base.html" %}
{% block title %}Control Panel | Data Entry{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
    .section-title { color: #FF6B00 !important; border-bottom: 1px solid #333; padding-bottom: 5px; }
    #map { border: 2px solid #FF6B00; filter: grayscale(1) invert(1); }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-wrapper py-5">
    <div class="glass-card p-4">
        <h4 class="mb-4 fw-bold" style="color: #FF6B00;">> SENSOR DATA UPLOAD_</h4>
        <form method="POST" action="{{ url_for('main.save_data') }}" enctype="multipart/form-data">
            
            <div class="section-title mb-3">01. GEOLOCATION</div>
            <button type="button" class="custom-btn mb-3" onclick="getLocation()">GPS DETECT</button>
            <div class="row g-3">
                <div class="col-md-6"><input type="text" id="latitude" name="latitude" class="form-control" placeholder="LAT" required></div>
                <div class="col-md-6"><input type="text" id="longitude" name="longitude" class="form-control" placeholder="LONG" required></div>
            </div>
            <div id="map" class="mt-3"></div>

            <div class="section-title mt-4 mb-3">02. IDENTIFICATION</div>
            <div class="row">
                <div class="col-md-6"><select class="form-select mb-3" id="waterType" name="water_type" required></select></div>
                <div class="col-md-6"><input type="text" name="pin_id" class="form-control mb-3" placeholder="HARDWARE PIN ID" required></div>
            </div>

            <div class="section-title mt-4 mb-3">03. SENSOR TELEMETRY</div>
            <button type="button" class="custom-btn mb-3" onclick="scanBLE()">SYNC BLE</button>
            <p class="small">SIGNAL: <span id="bleStatus" class="status-disconnected">DISCONNECTED</span></p>

            <div class="row g-3">
                <div class="col-md-4"><div class="sensor-box"><label class="small text-muted d-block">TEMP</label><input class="form-control" name="temperature"></div></div>
                <div class="col-md-4"><div class="sensor-box"><label class="small text-muted d-block">PH</label><input class="form-control" name="ph"></div></div>
                <div class="col-md-4"><div class="sensor-box"><label class="small text-muted d-block">TDS</label><input class="form-control" name="tds"></div></div>
            </div>

            <div id="pondSensors" class="row g-3 mt-3" style="display:none;">
                <div class="col-md-4"><div class="sensor-box"><label class="small text-muted d-block">D.OXYGEN</label><input class="form-control" name="do"></div></div>
            </div>

            <div class="section-title mt-4 mb-3">04. VISUAL CAPTURE</div>
            <input type="file" name="image" class="form-control mb-4">

            <button type="submit" class="custom-btn w-100 py-3">TRANSMIT DATA</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let category = "{{ category }}";
let map = null; let marker = null;
window.onload = function() {
    const dropdown = document.getElementById("waterType");
    let options = category === "ocean" ? ["Open Ocean Water", "Coastal Water", "Estuarine Water", "Deep Sea Water", "Marine Surface Water"] : ["Pond Water", "Drinking Water", "Ground Water"];
    if(category === "pond") document.getElementById("pondSensors").style.display = "flex";
    options.forEach(type => {
        let opt = document.createElement("option"); opt.value = type; opt.textContent = type; dropdown.appendChild(opt);
    });
};
function getLocation(){
    if(!navigator.geolocation) return;
    navigator.geolocation.getCurrentPosition(function(pos){
        const lat = pos.coords.latitude; const lon = pos.coords.longitude;
        document.getElementById("latitude").value = lat; document.getElementById("longitude").value = lon;
        showMap(lat, lon);
    });
}
function showMap(lat, lon){
    document.getElementById("map").style.display = "block";
    if(!map){
        map = L.map('map').setView([lat, lon], 13);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
    } else { map.setView([lat, lon], 13); }
    if(marker){ marker.setLatLng([lat, lon]); } else { marker = L.marker([lat, lon]).addTo(map); }
    map.invalidateSize();
}
async function scanBLE(){
    const status = document.getElementById("bleStatus");
    try { await navigator.bluetooth.requestDevice({acceptAllDevices:true}); status.innerText="SYNCED"; status.className="status-connected"; }
    catch { status.innerText="SYNC_ERROR"; status.className="status-disconnected"; }
}
</script>
{% endblock %}

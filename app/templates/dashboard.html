{% block scripts %}
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>

let map;
let marker;

// ===============================
// LOCATION (MOBILE SAFE)
// ===============================
function getLocation() {

    if (!navigator.geolocation) {
        alert("Geolocation not supported.");
        return;
    }

    navigator.geolocation.getCurrentPosition(function(position) {

        const lat = position.coords.latitude;
        const lon = position.coords.longitude;

        document.getElementById("latitude").value = lat;
        document.getElementById("longitude").value = lon;

        // Small delay ensures proper render on mobile
        setTimeout(() => {

            if (!map) {
                map = L.map('map').setView([lat, lon], 13);

                L.tileLayer(
                    'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                    {
                        attribution: '&copy; OpenStreetMap contributors'
                    }
                ).addTo(map);
            } else {
                map.setView([lat, lon], 13);
            }

            if (marker) {
                marker.setLatLng([lat, lon]);
            } else {
                marker = L.marker([lat, lon]).addTo(map);
            }

            map.invalidateSize(); // IMPORTANT for mobile render fix

        }, 300);

    }, function(error) {
        alert("Location permission denied.");
    });
}


// ===============================
// BLUETOOTH (REAL SCAN STYLE)
// ===============================
async function scanBLE() {

    const status = document.getElementById("bleStatus");

    try {

        // For real ESP32 you can later add:
        // filters: [{ namePrefix: "ESP" }]

        const device = await navigator.bluetooth.requestDevice({
            acceptAllDevices: true,
            optionalServices: []
        });

        status.innerText = "Connected to " + (device.name || "Unnamed Device");
        status.classList.remove("status-disconnected");
        status.classList.add("status-connected");

        console.log("Connected device:", device);

    } catch (error) {

        status.innerText = "Not Connected";
        status.classList.remove("status-connected");
        status.classList.add("status-disconnected");

        console.log("Bluetooth Error:", error);
    }
}


// ===============================
// SENSOR (PLACEHOLDER)
// ===============================
function readSensor() {
    alert("ESP32 backend integration required for live sensor data.");
}

</script>
{% endblock %}
